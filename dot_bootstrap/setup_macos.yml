---
- name: MacOS machine setup
  hosts: all
  connection: local
  gather_facts: true
  
  vars:
    ansible_python_interpreter: /usr/bin/python3
    remote_regular_user: "{{ lookup('env', 'USER') }}"  # Auto-detect current user

  tasks:
    - name: Install homebrew casks
      community.general.homebrew_cask:
        name: "{{ item }}"
        state: present
      with_items:
        - docker
        - visual-studio-code 
        - ghostty
        - obsidian

    - name: Install homebrew packages
      community.general.homebrew:
        name: "{{ item }}"
        state: present
      with_items:
        - fish
        - fisher
        - tmux
        - starship
        - age
        - git
        - lazygit
        - make
        - uv
        - rustup
        - bob
        - docker-compose
        - mutagen-io/mutagen/mutagen
        - eza

    - name: Get brew prefix
      ansible.builtin.command: brew --prefix
      register: brew_prefix

    - name: Ensure fish is in /etc/shells
      become: true
      ansible.builtin.lineinfile:
        path: /etc/shells
        line: "{{ brew_prefix.stdout }}/bin/fish"
        state: present

    - name: Change shell to fish for remote user
      become: true
      ansible.builtin.user:
        name: "{{ remote_regular_user }}"
        shell: "{{ brew_prefix.stdout }}/bin/fish"

    - name: Setup neovim with bob
      become: true
      become_user: root
      ansible.builtin.shell: |
        bob install stable
        bob use stable 
